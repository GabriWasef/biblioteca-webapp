<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biblioteca Manager - Sistema Gestionale</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --color-primary: #8B4513;
            --color-secondary: #D2B48C;
            --color-accent: #2F4F2F;
            --color-bg: #FFF8DC;
            --color-surface: #FFFAF0;
            --color-text: #3E2723;
            --color-border: #D7CCC8;
        }

        body {
            font-family: 'Georgia', 'Times New Roman', serif;
            background: linear-gradient(135deg, #FFF8DC 0%, #F5DEB3 100%);
            color: var(--color-text);
            min-height: 100vh;
        }

        .navbar {
            background: linear-gradient(135deg, var(--color-primary) 0%, #6B3410 100%);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            padding: 1rem 0;
        }

        .navbar-brand {
            color: var(--color-bg) !important;
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .navbar-brand i {
            font-size: 2rem;
        }

        .nav-link {
            color: var(--color-secondary) !important;
            font-weight: 500;
            margin: 0 0.5rem;
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }

        .nav-link:hover, .nav-link.active {
            color: var(--color-bg) !important;
            border-bottom-color: var(--color-bg);
        }

        .main-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .page-header {
            background: var(--color-surface);
            border-left: 5px solid var(--color-primary);
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .page-header h1 {
            color: var(--color-primary);
            margin: 0;
            font-size: 2rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .card-header {
            background: linear-gradient(135deg, var(--color-secondary) 0%, #C4A676 100%);
            color: var(--color-text);
            font-weight: 600;
            border-bottom: 2px solid var(--color-primary);
            padding: 1rem 1.5rem;
        }

        .table {
            background: var(--color-surface);
            color: var(--color-text);
        }

        .table thead {
            background: var(--color-accent);
            color: white;
        }

        .table tbody tr {
            transition: all 0.2s ease;
        }

        .table tbody tr:hover {
            background: var(--color-secondary);
            transform: translateX(5px);
        }

        .btn-primary {
            background: var(--color-primary);
            border: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: #6B3410;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 69, 19, 0.3);
        }

        .btn-success {
            background: var(--color-accent);
            border: none;
        }

        .btn-success:hover {
            background: #1F3F1F;
        }

        .btn-warning {
            background: #D4A017;
            border: none;
            color: white;
        }

        .btn-danger {
            background: #8B0000;
            border: none;
        }

        .badge {
            font-weight: 500;
            padding: 0.5rem 0.75rem;
        }

        .badge-overdue {
            background: #8B0000;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .modal-content {
            background: var(--color-surface);
            border: 2px solid var(--color-border);
        }

        .modal-header {
            background: var(--color-secondary);
            color: var(--color-text);
            border-bottom: 2px solid var(--color-primary);
        }

        .form-control, .form-select {
            border: 1px solid var(--color-border);
            background: white;
            color: var(--color-text);
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 0.25rem rgba(139, 69, 19, 0.25);
        }

        .alert {
            border-radius: 8px;
            border: none;
        }

        .book-icon {
            color: var(--color-primary);
            margin-right: 0.5rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--color-text);
            opacity: 0.7;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .navbar-brand {
                font-size: 1.2rem;
            }

            .page-header h1 {
                font-size: 1.5rem;
            }

            .table {
                font-size: 0.875rem;
            }

            .btn {
                font-size: 0.875rem;
                padding: 0.375rem 0.75rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#home">
                <i class="bi bi-book-fill"></i>
                Biblioteca Manager
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#home" data-page="home">
                            <i class="bi bi-house-fill"></i> Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#libri" data-page="libri">
                            <i class="bi bi-book"></i> Libri
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#lettori" data-page="lettori">
                            <i class="bi bi-people-fill"></i> Lettori
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#prestiti" data-page="prestiti">
                            <i class="bi bi-arrow-left-right"></i> Prestiti
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-container">
        <!-- Home Page -->
        <div id="page-home" class="page-content">
            <div class="page-header">
                <h1><i class="bi bi-house-fill"></i> Benvenuto in Biblioteca Manager</h1>
            </div>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="bi bi-book-fill" style="font-size: 3rem; color: var(--color-primary);"></i>
                            <h3 id="count-libri">0</h3>
                            <p>Libri nel Catalogo</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="bi bi-people-fill" style="font-size: 3rem; color: var(--color-accent);"></i>
                            <h3 id="count-lettori">0</h3>
                            <p>Lettori Registrati</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="bi bi-arrow-left-right" style="font-size: 3rem; color: #D4A017;"></i>
                            <h3 id="count-prestiti">0</h3>
                            <p>Prestiti Attivi</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Libri Page -->
        <div id="page-libri" class="page-content" style="display: none;">
            <div class="page-header">
                <h1><i class="bi bi-book-fill"></i> Gestione Libri</h1>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-3">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalLibro" onclick="openLibroModal('add')">
                    <i class="bi bi-plus-circle"></i> Aggiungi Libro
                </button>
                <div class="d-flex align-items-center gap-2">
                    <label class="mb-0">Mostra:</label>
                    <select class="form-select form-select-sm" id="libri-page-size" onchange="changeLibriPageSize()" style="width: auto;">
                        <option value="5">5</option>
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="-1">Tutti</option>
                    </select>
                    <span class="mb-0">righe</span>
                </div>
            </div>

            <div id="alert-container"></div>

            <div class="card">
                <div class="card-header">
                    <i class="bi bi-list-ul"></i> Catalogo Libri
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Titolo</th>
                                    <th>Autore</th>
                                    <th>Anno</th>
                                    <th>Genere</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="libri-table-body">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <div class="card-footer d-flex justify-content-between align-items-center">
                        <div id="libri-info" class="text-muted"></div>
                        <div>
                            <button class="btn btn-sm btn-secondary" id="libri-prev" onclick="changeLibriPage(-1)">
                                <i class="bi bi-chevron-left"></i> Precedente
                            </button>
                            <span class="mx-2" id="libri-page-indicator"></span>
                            <button class="btn btn-sm btn-secondary" id="libri-next" onclick="changeLibriPage(1)">
                                Successivo <i class="bi bi-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lettori Page -->
        <div id="page-lettori" class="page-content" style="display: none;">
            <div class="page-header">
                <h1><i class="bi bi-people-fill"></i> Gestione Lettori</h1>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-3">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalLettore" onclick="openLettoreModal('add')">
                    <i class="bi bi-plus-circle"></i> Aggiungi Lettore
                </button>
                <div class="d-flex align-items-center gap-2">
                    <label class="mb-0">Mostra:</label>
                    <select class="form-select form-select-sm" id="lettori-page-size" onchange="changelettoriPageSize()" style="width: auto;">
                        <option value="5">5</option>
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="-1">Tutti</option>
                    </select>
                    <span class="mb-0">righe</span>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="bi bi-list-ul"></i> Elenco Lettori
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nome</th>
                                    <th>Cognome</th>
                                    <th>Email</th>
                                    <th>Città</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="lettori-table-body">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <div class="card-footer d-flex justify-content-between align-items-center">
                        <div id="lettori-info" class="text-muted"></div>
                        <div>
                            <button class="btn btn-sm btn-secondary" id="lettori-prev" onclick="changeLettoriPage(-1)">
                                <i class="bi bi-chevron-left"></i> Precedente
                            </button>
                            <span class="mx-2" id="lettori-page-indicator"></span>
                            <button class="btn btn-sm btn-secondary" id="lettori-next" onclick="changeLettoriPage(1)">
                                Successivo <i class="bi bi-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Prestiti Page -->
        <div id="page-prestiti" class="page-content" style="display: none;">
            <div class="page-header">
                <h1><i class="bi bi-arrow-left-right"></i> Gestione Prestiti</h1>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-3">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalPrestito" onclick="openPrestitoModal('add')">
                    <i class="bi bi-plus-circle"></i> Nuovo Prestito
                </button>
                <div class="d-flex align-items-center gap-2">
                    <label class="mb-0">Mostra:</label>
                    <select class="form-select form-select-sm" id="prestiti-page-size" onchange="changePrestitiPageSize()" style="width: auto;">
                        <option value="5">5</option>
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="-1">Tutti</option>
                    </select>
                    <span class="mb-0">righe</span>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="bi bi-list-ul"></i> Elenco Prestiti
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Libro</th>
                                    <th>Lettore</th>
                                    <th>Data Prestito</th>
                                    <th>Data Restituzione</th>
                                    <th>Stato</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="prestiti-table-body">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <div class="card-footer d-flex justify-content-between align-items-center">
                        <div id="prestiti-info" class="text-muted"></div>
                        <div>
                            <button class="btn btn-sm btn-secondary" id="prestiti-prev" onclick="changePrestitiPage(-1)">
                                <i class="bi bi-chevron-left"></i> Precedente
                            </button>
                            <span class="mx-2" id="prestiti-page-indicator"></span>
                            <button class="btn btn-sm btn-secondary" id="prestiti-next" onclick="changePrestitiPage(1)">
                                Successivo <i class="bi bi-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Libro -->
    <div class="modal fade" id="modalLibro" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLibroTitle">Aggiungi Libro</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formLibro">
                        <input type="hidden" id="libro-id">
                        <div class="mb-3">
                            <label class="form-label">Titolo</label>
                            <input type="text" class="form-control" id="libro-titolo" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Autore</label>
                            <input type="text" class="form-control" id="libro-autore" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Anno Pubblicazione</label>
                            <input type="number" class="form-control" id="libro-anno" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Genere</label>
                            <input type="text" class="form-control" id="libro-genere" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="button" class="btn btn-primary" onclick="saveLibro()">Salva</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Lettore -->
    <div class="modal fade" id="modalLettore" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLettoreTitle">Aggiungi Lettore</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formLettore">
                        <input type="hidden" id="lettore-id">
                        <div class="mb-3">
                            <label class="form-label">Nome</label>
                            <input type="text" class="form-control" id="lettore-nome" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Cognome</label>
                            <input type="text" class="form-control" id="lettore-cognome" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="lettore-email" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Città</label>
                            <input type="text" class="form-control" id="lettore-citta" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="button" class="btn btn-primary" onclick="saveLettore()">Salva</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Prestito -->
    <div class="modal fade" id="modalPrestito" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalPrestitoTitle">Nuovo Prestito</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formPrestito">
                        <input type="hidden" id="prestito-id">
                        <div class="mb-3">
                            <label class="form-label">Libro</label>
                            <select class="form-select" id="prestito-libro" required>
                                <option value="">Seleziona un libro...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Lettore</label>
                            <select class="form-select" id="prestito-lettore" required>
                                <option value="">Seleziona un lettore...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Data Prestito</label>
                            <input type="date" class="form-control" id="prestito-data-prestito" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Data Restituzione (opzionale)</label>
                            <input type="date" class="form-control" id="prestito-data-restituzione">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="button" class="btn btn-primary" onclick="savePrestito()">Salva</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // API Base URL - MODIFICA QUESTO URL CON IL TUO ENDPOINT FLASK
        const API_BASE = 'http://127.0.0.1:5000/api';

        // Pagination state
        let libriData = [];
        let libriCurrentPage = 1;
        let libriPageSize = 5;

        let lettoriData = [];
        let lettoriCurrentPage = 1;
        let lettoriPageSize = 5;

        let prestitiData = [];
        let prestitiCurrentPage = 1;
        let prestitiPageSize = 5;

        // Navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const page = link.dataset.page;
                showPage(page);
                
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
            });
        });

        function showPage(pageName) {
            document.querySelectorAll('.page-content').forEach(page => {
                page.style.display = 'none';
            });
            document.getElementById(`page-${pageName}`).style.display = 'block';
            
            if (pageName === 'libri') loadLibri();
            else if (pageName === 'lettori') loadLettori();
            else if (pageName === 'prestiti') loadPrestiti();
            else if (pageName === 'home') loadDashboard();
        }

        // Alert Helper
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alert-container');
            alertContainer.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            setTimeout(() => alertContainer.innerHTML = '', 5000);
        }

        // Dashboard
        async function loadDashboard() {
            try {
                const [libri, lettori, prestiti] = await Promise.all([
                    fetch(`${API_BASE}/libri`).then(r => r.json()),
                    fetch(`${API_BASE}/lettori`).then(r => r.json()),
                    fetch(`${API_BASE}/prestiti`).then(r => r.json())
                ]);
                
                document.getElementById('count-libri').textContent = libri.length;
                document.getElementById('count-lettori').textContent = lettori.length;
                document.getElementById('count-prestiti').textContent = 
                    prestiti.filter(p => !p.data_restituzione).length;
            } catch (error) {
                console.error('Errore caricamento dashboard:', error);
            }
        }

        // LIBRI CRUD
        async function loadLibri() {
            try {
                const response = await fetch(`${API_BASE}/libri`);
                libriData = await response.json();
                libriCurrentPage = 1;
                renderLibri();
            } catch (error) {
                console.error('Errore caricamento libri:', error);
                showAlert('Errore nel caricamento dei libri', 'danger');
            }
        }

        function renderLibri() {
            const tbody = document.getElementById('libri-table-body');
            
            if (libriData.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="6" class="empty-state">
                        <i class="bi bi-book"></i>
                        <p>Nessun libro nel catalogo</p>
                    </td></tr>
                `;
                document.getElementById('libri-info').textContent = '';
                document.getElementById('libri-page-indicator').textContent = '';
                return;
            }

            const start = (libriCurrentPage - 1) * libriPageSize;
            const end = libriPageSize === -1 ? libriData.length : start + libriPageSize;
            const paginatedData = libriData.slice(start, end);
            const totalPages = libriPageSize === -1 ? 1 : Math.ceil(libriData.length / libriPageSize);

            tbody.innerHTML = paginatedData.map(libro => `
                <tr>
                    <td>${libro.id_libro}</td>
                    <td><i class="bi bi-book-fill book-icon"></i>${libro.titolo}</td>
                    <td>${libro.autore}</td>
                    <td>${libro.anno_pubblicazione}</td>
                    <td><span class="badge bg-secondary">${libro.genere}</span></td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="openLibroModal('edit', ${libro.id_libro})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteLibro(${libro.id_libro})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');

            // Update pagination info
            const showing = libriPageSize === -1 ? libriData.length : Math.min(end, libriData.length);
            document.getElementById('libri-info').textContent = 
                `Mostrando ${start + 1}-${showing} di ${libriData.length} risultati`;
            
            if (libriPageSize === -1) {
                document.getElementById('libri-page-indicator').textContent = '';
                document.getElementById('libri-prev').disabled = true;
                document.getElementById('libri-next').disabled = true;
            } else {
                document.getElementById('libri-page-indicator').textContent = 
                    `Pagina ${libriCurrentPage} di ${totalPages}`;
                document.getElementById('libri-prev').disabled = libriCurrentPage === 1;
                document.getElementById('libri-next').disabled = libriCurrentPage === totalPages;
            }
        }

        function changeLibriPage(direction) {
            libriCurrentPage += direction;
            renderLibri();
        }

        function changeLibriPageSize() {
            libriPageSize = parseInt(document.getElementById('libri-page-size').value);
            libriCurrentPage = 1;
            renderLibri();
        }

        function openLibroModal(mode, id = null) {
            const modal = document.getElementById('modalLibro');
            const title = document.getElementById('modalLibroTitle');
            
            if (mode === 'add') {
                title.textContent = 'Aggiungi Libro';
                document.getElementById('formLibro').reset();
                document.getElementById('libro-id').value = '';
            } else {
                title.textContent = 'Modifica Libro';
                fetch(`${API_BASE}/libri/${id}`)
                    .then(r => r.json())
                    .then(libro => {
                        document.getElementById('libro-id').value = libro.id_libro;
                        document.getElementById('libro-titolo').value = libro.titolo;
                        document.getElementById('libro-autore').value = libro.autore;
                        document.getElementById('libro-anno').value = libro.anno_pubblicazione;
                        document.getElementById('libro-genere').value = libro.genere;
                    });
            }
        }

        async function saveLibro() {
            const id = document.getElementById('libro-id').value;
            const data = {
                titolo: document.getElementById('libro-titolo').value,
                autore: document.getElementById('libro-autore').value,
                anno_pubblicazione: parseInt(document.getElementById('libro-anno').value),
                genere: document.getElementById('libro-genere').value
            };

            const url = id ? `${API_BASE}/libri/${id}` : `${API_BASE}/libri`;
            const method = id ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('modalLibro')).hide();
                    loadLibri();
                    showAlert(id ? 'Libro aggiornato con successo' : 'Libro aggiunto con successo');
                }
            } catch (error) {
                console.error('Errore salvataggio libro:', error);
                showAlert('Errore nel salvataggio', 'danger');
            }
        }

        async function deleteLibro(id) {
            if (!confirm('Sei sicuro di voler eliminare questo libro?')) return;

            try {
                const response = await fetch(`${API_BASE}/libri/${id}`, {method: 'DELETE'});
                if (response.ok) {
                    loadLibri();
                    showAlert('Libro eliminato con successo');
                }
            } catch (error) {
                console.error('Errore eliminazione libro:', error);
                showAlert('Errore nell\'eliminazione', 'danger');
            }
        }

        // LETTORI CRUD
        async function loadLettori() {
            try {
                const response = await fetch(`${API_BASE}/lettori`);
                lettoriData = await response.json();
                lettoriCurrentPage = 1;
                renderLettori();
            } catch (error) {
                console.error('Errore caricamento lettori:', error);
            }
        }

        function renderLettori() {
            const tbody = document.getElementById('lettori-table-body');
            
            if (lettoriData.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="6" class="empty-state">
                        <i class="bi bi-people"></i>
                        <p>Nessun lettore registrato</p>
                    </td></tr>
                `;
                document.getElementById('lettori-info').textContent = '';
                document.getElementById('lettori-page-indicator').textContent = '';
                return;
            }

            const start = (lettoriCurrentPage - 1) * lettoriPageSize;
            const end = lettoriPageSize === -1 ? lettoriData.length : start + lettoriPageSize;
            const paginatedData = lettoriData.slice(start, end);
            const totalPages = lettoriPageSize === -1 ? 1 : Math.ceil(lettoriData.length / lettoriPageSize);

            tbody.innerHTML = paginatedData.map(lettore => `
                <tr>
                    <td>${lettore.id_lettore}</td>
                    <td>${lettore.nome}</td>
                    <td>${lettore.cognome}</td>
                    <td>${lettore.email}</td>
                    <td>${lettore.citta}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="openLettoreModal('edit', ${lettore.id_lettore})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteLettore(${lettore.id_lettore})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');

            const showing = lettoriPageSize === -1 ? lettoriData.length : Math.min(end, lettoriData.length);
            document.getElementById('lettori-info').textContent = 
                `Mostrando ${start + 1}-${showing} di ${lettoriData.length} risultati`;
            
            if (lettoriPageSize === -1) {
                document.getElementById('lettori-page-indicator').textContent = '';
                document.getElementById('lettori-prev').disabled = true;
                document.getElementById('lettori-next').disabled = true;
            } else {
                document.getElementById('lettori-page-indicator').textContent = 
                    `Pagina ${lettoriCurrentPage} di ${totalPages}`;
                document.getElementById('lettori-prev').disabled = lettoriCurrentPage === 1;
                document.getElementById('lettori-next').disabled = lettoriCurrentPage === totalPages;
            }
        }

        function changeLettoriPage(direction) {
            lettoriCurrentPage += direction;
            renderLettori();
        }

        function changeLettoriPageSize() {
            lettoriPageSize = parseInt(document.getElementById('lettori-page-size').value);
            lettoriCurrentPage = 1;
            renderLettori();
        }

        function openLettoreModal(mode, id = null) {
            const title = document.getElementById('modalLettoreTitle');
            
            if (mode === 'add') {
                title.textContent = 'Aggiungi Lettore';
                document.getElementById('formLettore').reset();
                document.getElementById('lettore-id').value = '';
            } else {
                title.textContent = 'Modifica Lettore';
                fetch(`${API_BASE}/lettori/${id}`)
                    .then(r => r.json())
                    .then(lettore => {
                        document.getElementById('lettore-id').value = lettore.id_lettore;
                        document.getElementById('lettore-nome').value = lettore.nome;
                        document.getElementById('lettore-cognome').value = lettore.cognome;
                        document.getElementById('lettore-email').value = lettore.email;
                        document.getElementById('lettore-citta').value = lettore.citta;
                    });
            }
        }

        async function saveLettore() {
            const id = document.getElementById('lettore-id').value;
            const data = {
                nome: document.getElementById('lettore-nome').value,
                cognome: document.getElementById('lettore-cognome').value,
                email: document.getElementById('lettore-email').value,
                citta: document.getElementById('lettore-citta').value
            };

            const url = id ? `${API_BASE}/lettori/${id}` : `${API_BASE}/lettori`;
            const method = id ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('modalLettore')).hide();
                    loadLettori();
                    showAlert(id ? 'Lettore aggiornato con successo' : 'Lettore aggiunto con successo');
                }
            } catch (error) {
                console.error('Errore salvataggio lettore:', error);
                showAlert('Errore nel salvataggio', 'danger');
            }
        }

        async function deleteLettore(id) {
            if (!confirm('Sei sicuro di voler eliminare questo lettore?')) return;

            try {
                const response = await fetch(`${API_BASE}/lettori/${id}`, {method: 'DELETE'});
                if (response.ok) {
                    loadLettori();
                    showAlert('Lettore eliminato con successo');
                }
            } catch (error) {
                console.error('Errore eliminazione lettore:', error);
                showAlert('Errore nell\'eliminazione', 'danger');
            }
        }

        // PRESTITI CRUD
        async function loadPrestiti() {
            try {
                const response = await fetch(`${API_BASE}/prestiti`);
                prestitiData = await response.json();
                prestitiCurrentPage = 1;
                renderPrestiti();
            } catch (error) {
                console.error('Errore caricamento prestiti:', error);
            }
        }

        function renderPrestiti() {
            const tbody = document.getElementById('prestiti-table-body');
            
            if (prestitiData.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="7" class="empty-state">
                        <i class="bi bi-arrow-left-right"></i>
                        <p>Nessun prestito registrato</p>
                    </td></tr>
                `;
                document.getElementById('prestiti-info').textContent = '';
                document.getElementById('prestiti-page-indicator').textContent = '';
                return;
            }

            const start = (prestitiCurrentPage - 1) * prestitiPageSize;
            const end = prestitiPageSize === -1 ? prestitiData.length : start + prestitiPageSize;
            const paginatedData = prestitiData.slice(start, end);
            const totalPages = prestitiPageSize === -1 ? 1 : Math.ceil(prestitiData.length / prestitiPageSize);

            const today = new Date();
            tbody.innerHTML = paginatedData.map(prestito => {
                const isOverdue = !prestito.data_restituzione && 
                    new Date(prestito.data_prestito) < new Date(today - 30*24*60*60*1000);
                const statusBadge = prestito.data_restituzione 
                    ? '<span class="badge bg-success">Restituito</span>'
                    : isOverdue 
                        ? '<span class="badge badge-overdue">In Ritardo</span>'
                        : '<span class="badge bg-primary">In Prestito</span>';
                
                return `
                    <tr>
                        <td>${prestito.id_prestito}</td>
                        <td>${prestito.libro_titolo || `ID: ${prestito.id_libro}`}</td>
                        <td>${prestito.lettore_nome || `ID: ${prestito.id_lettore}`}</td>
                        <td>${new Date(prestito.data_prestito).toLocaleDateString('it-IT')}</td>
                        <td>${prestito.data_restituzione ? new Date(prestito.data_restituzione).toLocaleDateString('it-IT') : '-'}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="openPrestitoModal('edit', ${prestito.id_prestito})">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deletePrestito(${prestito.id_prestito})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            const showing = prestitiPageSize === -1 ? prestitiData.length : Math.min(end, prestitiData.length);
            document.getElementById('prestiti-info').textContent = 
                `Mostrando ${start + 1}-${showing} di ${prestitiData.length} risultati`;
            
            if (prestitiPageSize === -1) {
                document.getElementById('prestiti-page-indicator').textContent = '';
                document.getElementById('prestiti-prev').disabled = true;
                document.getElementById('prestiti-next').disabled = true;
            } else {
                document.getElementById('prestiti-page-indicator').textContent = 
                    `Pagina ${prestitiCurrentPage} di ${totalPages}`;
                document.getElementById('prestiti-prev').disabled = prestitiCurrentPage === 1;
                document.getElementById('prestiti-next').disabled = prestitiCurrentPage === totalPages;
            }
        }

        function changePrestitiPage(direction) {
            prestitiCurrentPage += direction;
            renderPrestiti();
        }

        function changePrestitiPageSize() {
            prestitiPageSize = parseInt(document.getElementById('prestiti-page-size').value);
            prestitiCurrentPage = 1;
            renderPrestiti();
        }

        async function openPrestitoModal(mode, id = null) {
            // Load dropdown options
            const [libri, lettori] = await Promise.all([
                fetch(`${API_BASE}/libri`).then(r => r.json()),
                fetch(`${API_BASE}/lettori`).then(r => r.json())
            ]);

            document.getElementById('prestito-libro').innerHTML = 
                '<option value="">Seleziona un libro...</option>' +
                libri.map(l => `<option value="${l.id_libro}">${l.titolo}</option>`).join('');
            
            document.getElementById('prestito-lettore').innerHTML = 
                '<option value="">Seleziona un lettore...</option>' +
                lettori.map(l => `<option value="${l.id_lettore}">${l.nome} ${l.cognome}</option>`).join('');

            const title = document.getElementById('modalPrestitoTitle');
            
            if (mode === 'add') {
                title.textContent = 'Nuovo Prestito';
                document.getElementById('formPrestito').reset();
                document.getElementById('prestito-id').value = '';
                document.getElementById('prestito-data-prestito').valueAsDate = new Date();
            } else {
                title.textContent = 'Modifica Prestito';
                const prestito = await fetch(`${API_BASE}/prestiti/${id}`).then(r => r.json());
                document.getElementById('prestito-id').value = prestito.id_prestito;
                document.getElementById('prestito-libro').value = prestito.id_libro;
                document.getElementById('prestito-lettore').value = prestito.id_lettore;
                document.getElementById('prestito-data-prestito').value = prestito.data_prestito;
                document.getElementById('prestito-data-restituzione').value = prestito.data_restituzione || '';
            }
        }

        async function savePrestito() {
            const id = document.getElementById('prestito-id').value;
            const data = {
                id_libro: parseInt(document.getElementById('prestito-libro').value),
                id_lettore: parseInt(document.getElementById('prestito-lettore').value),
                data_prestito: document.getElementById('prestito-data-prestito').value,
                data_restituzione: document.getElementById('prestito-data-restituzione').value || null
            };

            const url = id ? `${API_BASE}/prestiti/${id}` : `${API_BASE}/prestiti`;
            const method = id ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('modalPrestito')).hide();
                    loadPrestiti();
                    showAlert(id ? 'Prestito aggiornato con successo' : 'Prestito registrato con successo');
                }
            } catch (error) {
                console.error('Errore salvataggio prestito:', error);
                showAlert('Errore nel salvataggio', 'danger');
            }
        }

        async function deletePrestito(id) {
            if (!confirm('Sei sicuro di voler eliminare questo prestito?')) return;

            try {
                const response = await fetch(`${API_BASE}/prestiti/${id}`, {method: 'DELETE'});
                if (response.ok) {
                    loadPrestiti();
                    showAlert('Prestito eliminato con successo');
                }
            } catch (error) {
                console.error('Errore eliminazione prestito:', error);
                showAlert('Errore nell\'eliminazione', 'danger');
            }
        }

        // Initialize
        showPage('home');
    </script>
</body>
</html>
